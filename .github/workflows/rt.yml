name: test rrk6

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # safety cap (6h hard limit anyway)

    env:
      TARGET_URL: ${{ secrets.TARGET_URL }}
      VUS: 99999
      DURATION: 1h

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          chmod +x setup.sh
          ./setup.sh

      - name: Create k6 test file
        run: |
          cat << 'EOF' > test.js
          import http from 'k6/http';
          import { check } from 'k6';

          export const options = {
            vus: Number(__ENV.VUS) || 99999,
            duration: __ENV.DURATION || '1h',
          };

          export default function () {
            const res = http.get(__ENV.TARGET_URL, { timeout: '10s' });
          
            check(res, {
              'status is 2xx or 4xx': (r) => r.status >= 200 && r.status < 500,
            });
          }
          EOF

      - name: Run k6
        run: |
          k6 run test.js
