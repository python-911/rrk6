name: test rrk6

on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

jobs:
  load-test:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      TARGET_URL: ${{ secrets.TARGET_URL }}
      VUS: 9999          # âœ… MUST be realistic on GitHub runner
      DURATION: 1h

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install k6
        run: |
          chmod +x setup.sh
          ./setup.sh

      - name: Create k6 test file
        run: |
          cat << 'EOF' > test.js
          import http from 'k6/http';
          import { check } from 'k6';

          export const options = {
            vus: Number(__ENV.VUS),
            duration: __ENV.DURATION,
          };

          export default function () {
            const res = http.get(__ENV.TARGET_URL, { timeout: '5s' });

            check(res, {
              'status is 2xx or 4xx': (r) => r.status >= 200 && r.status < 500,
            });
          }
          EOF

      - name: Debug k6 install & env
        run: |
          echo "Checking k6 binary..."
          which k6 || true
          k6 version || true
          touch /tmp/summary.json
      
          echo "TARGET_URL is:"
          echo "$TARGET_URL"
      
      - name: Run k6 (debug)
        run: |
          k6 run \
            --log-format=raw \
            --summary-export=/tmp/summary.json \
            test.js


